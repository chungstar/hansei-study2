<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>MBTI 과몰입 인간의 블로그</title>

  <!-- jQuery script -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>

  <!-- Bootstrap script & CSS -->
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>

  <!-- Summernote script & CSS -->
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
  <script src="./summernote-bs4.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.14/dist/lang/summernote-ko-KR.js"></script>

  <!-- font awesome cdn -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

  <!-- Local CSS -->
  <!-- <link rel="stylesheet" href="./css/reset.css">
  </link> -->
  <link rel="stylesheet" href="./css/write.css">
  </link>
</head>

<body>
  <div id="wrap">
    <header>
      <!-- <a href="#">
        <img src="./assets/icons/menu.png" alt="메뉴버튼">
      </a> -->
      <div class="MenuButton">
        <input type="checkbox" id="menuicon" />
        <label for="menuicon">
          <span></span>
          <span></span>
          <span></span>
        </label>
        <div class="sidebar">
          <div class="sidebar-box1">
            <button id="logInBtn">Google 로그인</button>
            <div id="Myinfo">
              <p class="nickname"></p>
            </div>
            <button id="logOutBtn" style="display: none; margin-left: auto">
              로그아웃
            </button>
          </div>

          <ul class="sidebar-box2">
            <li>
              <a href="#"><i class="far fa-bell"></i></a>내소식
            </li>
            <li>
              <a href="#"><i class="fas fa-child"></i></a>이웃목록
            </li>
            <li>
              <a href="#"><i class="fas fa-chart-line"></i></a>통계
            </li>
            <li>
              <a href="write.html"><i class="fas fa-pen"></i></a>글쓰기
            </li>
          </ul>

          <div class="sidebar-box3">
            <div>
              <span>날짜별 댓글수</span>
              <span class="date"></span>
              <script>
                let i = new Date();
                let date = i.getMonth() + 1 + "월 " + i.getDate() + "일";
                document.querySelector(".date").innerHTML = date;
                console.log(date)
              </script>
            </div>
            <ul class="graph">
              <li>
                <div class="rect1">
                  <span></span>
                </div>
                <p id="one"></p>
                <script>
                  i = new Date();
                  date = i.getMonth() + 1 + "월 " + (i.getDate() - 5) + "일";
                  document.querySelector("#one").innerHTML = date;
                </script>
              </li>
              <li>
                <div class="rect2">
                  <span></span>
                </div>
                <p id="two"></p>
                <script>
                  date = i.getMonth() + 1 + "월 " + (i.getDate() - 4) + "일";
                  document.querySelector("#two").innerHTML = date;
                </script>
              </li>
              <li>
                <div class="rect3">
                  <span></span>
                </div>
                <p id="three"></p>
                <script>
                  date = i.getMonth() + 1 + "월 " + (i.getDate() - 3) + "일";
                  document.querySelector("#three").innerHTML = date;
                </script>
              </li>
              <li>
                <div class="rect4">
                  <span></span>
                </div>
                <p id="four"></p>
                <script>
                  date = i.getMonth() + 1 + "월 " + (i.getDate() - 2) + "일";
                  document.querySelector("#four").innerHTML = date;
                </script>
              </li>
              <li>
                <div class="rect5">
                  <span></span>
                </div>
                <p id="five"></p>
                <script>
                  date = i.getMonth() + 1 + "월 " + (i.getDate() - 1) + "일";
                  document.querySelector("#five").innerHTML = date;
                </script>
              </li>
              <li>
                <div class="rect6">
                  <span></span>
                </div>
                <p id="six"></p>
                <script>
                  date = i.getMonth() + 1 + "월 " + i.getDate() + "일";
                  document.querySelector("#six").innerHTML = date;
                </script>
              </li>
            </ul>
          </div>

          <div class="sidebar-box4">
            <ul>
              <a href="#">
                <li><i class="fas fa-desktop"></i>내 동영상</li>
              </a>
              <a href="#">
                <li><i class="fas fa-bolt"></i>내 모먼트</li>
              </a>
              <a href="#">
                <li><i class="far fa-clock"></i>지난 오늘 글</li>
              </a>
            </ul>
            <ul>
              <a href="#">
                <li><i class="fas fa-box"></i>마켓 플레이스</li>
              </a>
              <a href="#">
                <li><i class="fas fa-box-open"></i>마켓 구매내역</li>
              </a>
            </ul>
            <ul>
              <a href="#">
                <li><i class="fas fa-blog"></i>블로그 홈</li>
              </a>
              <a href="#">
                <li><i class="fab fa-blogger"></i>블로그팀 공식블로그</li>
              </a>
              <a href="#">
                <li><i class="fab fa-microblog"></i>이달의 블로그</li>
              </a>
              <a href="#">
                <li><i class="fas fa-check"></i>공식 블로그</li>
              </a>
            </ul>
          </div>
          <div class="sidebar-box5">
            <ul>
              <a href="#">
                <li>공지사항</li>
              </a>
              <a href="#">
                <li>환경설정</li>
              </a>
              <ul>
                <a href="#">
                  <li>로그인정보</li>
                </a>
                <li>songjae99</li>
              </ul>
              <a href="#">
                <li>PC버전으로 보기</li>
              </a>
              <a href="#">
                <li>블로그 고객센터</li>
              </a>
            </ul>
          </div>
        </div>
      </div>
      <!-- <div class="today">Today: 1234 / Total: 12345</div> -->
      <a href="/">
        <h1>MBTI 과몰입 인간의 블로그</h1>
      </a>
      <div class="header-right">
        <div id="profile"></div>
        <a href="#">
          <i class="fas fa-search"></i>
        </a>
        <a href="#">
          <i class="far fa-list-alt"></i>
        </a>
      </div>
    </header>

    <form action="">
      <div class="form-title">
        <h2>게시글 작성</h2>
        <div class="form-btn">
          <button type="submit" id="uploadBtn">등록</button>
          <button id="redirectPrevPage">취소</button>
          <!-- <input type="button" id="testBtn" value="test"> -->
        </div>
      </div>

      <div class="form-select">
        <label for="category-select"></label>
        <select name="category" id="category-select">
          <option selected disabled="disabled" value="카테고리 선택">카테고리 선택</option>
          <option id="스터디" value="스터디">스터디</option>
          <option id="일기" value="일기">일기</option>
          <option id="맛집일기" value="맛집일기">맛집일기</option>
          <option id="내돈내산후기" value="내돈내산 후기">내돈내산 후기</option>
        </select>

        <label for="open-select"></label>
        <select name="open" id="open-select">
          <option id="공개" value="공개" selected="selected">공개</option>
          <!-- <option id="비공개" value="비공개">비공개</option> -->
        </select>
      </div>

      <input type="text" placeholder="제목" id="title">
      <textarea id="summernote" name="editordata"></textarea>
      <input type="text" placeholder="#해시태그" id="hashtag">
    </form>
  </div>

  <!-- Firebase script -->
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <!-- Firestore script -->
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
  <!-- Authentication script -->
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
  <!-- Storage script -->
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

  <script>
    // Firebase 연결
    const firebaseConfig = {
      apiKey: "AIzaSyDJXIwvAOztzHf7WyXCSdJjjy9FNJenCic",
      authDomain: "blog-f9abc.firebaseapp.com",
      projectId: "blog-f9abc",
      storageBucket: "blog-f9abc.appspot.com",
      messagingSenderId: "982347300281",
      appId: "1:982347300281:web:d197799c076b0463db8a68",
      measurementId: "G-6G254LGX0S"
    };
    const app = firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const storage = firebase.storage()
    const Auth = firebase.auth();

    const category = document.querySelector('#category-select');
    const public = document.querySelector('#open-select');
    const title = document.querySelector('#title');
    const description = document.querySelector('textarea');
    const hashtag = document.querySelector('#hashtag');

    const uploadBtn = document.querySelector('#uploadBtn');
    const redirectPrevPage = document.querySelector('#redirectPrevPage');

    // Auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)

    let writer, writerImage;

    Auth.onAuthStateChanged((user) => {
      if (!user) {
        alert('접근 권한이 없습니다.')
        return window.location.href = "./"
      } else {

        const {
          uid,
          displayName,
          photoURL
        } = user;
        if (uid !== 'e5pzPCA40GMJr6cjzVrp6XHjlrX2') {
          alert('접근 권한이 없습니다.')
          window.location.href = "./"
        }
        writer = displayName;
        writerImage = photoURL;
      }
    })


    // 게시글 수정 부분
    const updateDocId = new URLSearchParams(window.location.search).get('id');
    if (updateDocId) {
      db.collection('post').doc(updateDocId).get().then(async (res) => {
        const content = await res.data();
        console.log(content)
        const {
          category,
          open,
          title,
          description,
          hashtag
        } = content;
        // console.log(description)
        document.querySelector(`#${category}`).setAttribute('selected', true);
        document.querySelector(`#${open}`).setAttribute('selected', true)
        document.querySelector('#title').value = title
        $('#summernote').summernote('pasteHTML', description)
        // console.log(description)
        document.querySelector('#hashtag').value = hashtag
      })
      // 등록 버튼 클릭 시 데이터 저장
      uploadBtn.addEventListener('click', async (event) => {
        event.preventDefault()
        console.log('click upload btn')

        if (category.value == '카테고리 선택') {
          return alert('카테고리 선택')
        } else if (!title.value) {
          return alert('제목 작성')
        }

        // Firestore 에 저장할 내용

        const desc = description.value

        const urlStart = desc.indexOf('src="') + 5
        const urlEnd = desc.indexOf('media', urlStart) + 5
        const firstImage = desc.substring(urlStart, urlEnd)

        const uploadObj = {
          // time: new Date(),
          category: category.value,
          open: public.value,
          title: title.value,
          description: desc,
          hashtag: hashtag
            .value
            .split(' '),
          text: $($("#summernote").summernote('code')).text(),
          firstImage,
        }
        try {
          // console.log(typeof (time))
          await db
            .collection('post')
            .doc(updateDocId)
            .update(uploadObj).then(() => {
              window.location.href = './'
            })
          // console.log(uploadObj)
          // console.log('Upload Content Success')
        } catch (error) {
          return console.log('Upload Content Error => ', error)
        }
      })
    } else {
      console.log('No exist docId')
      // 등록 버튼 클릭 시 데이터 저장
      uploadBtn.addEventListener('click', async (event) => {
        event.preventDefault()
        console.log('click upload btn')

        if (category.value == '카테고리 선택') {
          return alert('카테고리 선택')
        } else if (!title.value) {
          return alert('제목 작성')
        }

        // Firestore 에 저장할 내용
        const docId = Date.now().toString();

        const desc = description.value

        const urlStart = desc.indexOf('src="') + 5
        const urlEnd = desc.indexOf('media', urlStart) + 5
        const firstImage = desc.substring(urlStart, urlEnd)

        const uploadObj = {
          // time: new Date(),
          year: new Date().getFullYear() + '년',
          month: new Date().getMonth() + 1 + '월',
          date: new Date().getDate() + '일',
          time: new Date().toLocaleTimeString(),
          category: category.value,
          open: public.value,
          title: title.value,
          description: desc,
          hashtag: hashtag
            .value
            .split(' '),
          docId: docId,
          text: $($("#summernote").summernote('code')).text(),
          firstImage,
          like: 0,
          commentNumber: 0,
          writer,
          writerImage,
        }
        try {
          // console.log(typeof (time))
          await db
            .collection('post')
            .doc(docId)
            .set(uploadObj).then(() => {
              window.location.href = './'
            })
          // console.log(uploadObj)
          // console.log('Upload Content Success')
        } catch (error) {
          console.log('Upload Content Error => ', error)
        }
      })
    }

    const userStateChange = (nickname) => {
      document.querySelector('#logInBtn').style.display = "none";
      document.querySelector('#logOutBtn').style.display = "block";
      document.querySelector('#profile').innerHTML = `
        <span style="padding-right: 20px; color: #fff;">${nickname}님</span>
      `
    }
    // Auth.onAuthStateChanged((user) => {
    //   console.log(user)
    //   userStateChange(user.displayName)
    // })

    const logInBtn = document.querySelector('#logInBtn');


    // 구글 로그인 버튼 동작
    // document.querySelector('#logInBtn').addEventListener('click', () => {
    //   Auth.setPersistence(firebase.auth.Auth.Persistence.SESSION).then(async (res) => {
    //     const provider = new firebase.auth.GoogleAuthProvider();
    //     const logIn = await Auth.signInWithPopup(provider);
    //     console.log(logIn)
    //     if (logIn) {
    //       const {
    //         displayName,
    //         photoURL
    //       } = logIn.user
    //       // console.log(document.querySelector('#logInBtn'))
    //       userStateChange(displayName)
    //     }
    //   })
    // })


    // 로그아웃 버튼 동작
    // document.querySelector('#logOutBtn').addEventListener('click', () => {
    //   firebase.auth().signOut().then(() => {
    //     // Sign-out successful.
    //     console.log('logout success')
    //     document.querySelector('#logInBtn').style.display = "block";
    //     document.querySelector('#logOutBtn').style.display = "none";
    //     document.querySelector('#profile').innerHTML = ``;
    //   }).catch((error) => {
    //     // An error happened.
    //     console.log('logout error : ', error)
    //   });
    // })

    // Summernote 텍스트 에디터 실행문
    $(document).ready()

    // Summernote 이미지 업로드 기능 추가
    $('#summernote').summernote({
      height: 700,
      toolbar: [
        ['font', ['bold', 'underline', 'clear']],
        ['hr'],
        ['fontsize'],
        ['fontname', ['fontname']],
        ['color', ['color']],
        ['para', ['paragraph', 'height']],
        ['table', ['table']],
        ['insert', ['link', 'picture', 'video']],
      ],
      lang: 'ko-KR',
      callbacks: {
        onImageUpload: function (files, editor, welEditable) {
          uploadImage(files[0], this)
        }
      }
    })

    // Summernote 폰트 디폴트 값 변경
    $('#summernote').summernote('fontSize', 14);

    // Summernote 사이즈 조절 바 숨김
    $('.note-statusbar').hide();

    // Summernote 이미지 첨부 시 실행
    const uploadImage = (file, editor) => {
      console.log('Upload start')

      const image = file;
      const storageUrl = 'images/' + image.name
      const storageUpRef = storage.ref()
      const task = storageUpRef.child(storageUrl).put(file)

      // console.log('storageRef : ', storageUpRef)
      // console.log('image is : ', image.name)



      // Summernote 이미지 업로드 후 해당 링크로 경로 설정
      task.on('state_changed', (snapshot) => {
        console.log('Uploading...')
      }, (error) => {
        console.log('!!Uploading Error!! => ', error)
      }, () => {
        console.log('Upload Success!!')
        const storageRef = storage.ref()
        storageRef.child(storageUrl).getDownloadURL().then((url) => {
          // console.log('Image URL => ', url)
          const imageUrl = $('<img>').attr({
            src: url
          })
          $('#summernote').summernote('insertNode', imageUrl[0])
        }).catch((error) => {
          console.log('Get Url ERROR => ', error)
        })
      })

    }

    // document
    //   .querySelector('#testBtn')
    //   .addEventListener('click', () => {
    //     event.preventDefault()
    //     console.log(Auth.currentUser)

    //     Auth.onAuthStateChanged((user) => {
    //       console.log(user)
    //     })
    //     // const desc = description.value
    //     // const urlStart = desc.indexOf('src="') + 5
    //     // const urlEnd = desc.indexOf('media', urlStart) + 5
    //     // const link = desc.substring(urlStart, urlEnd)
    //     // console.log('link : ', link)
    //   })


    // redirectPrevPage.addEventListener('click', (event) => {
    //   event.preventDefault()
    //   console.log($($("#summernote").summernote('code')).text())
    // })
  </script>
</body>

</html>